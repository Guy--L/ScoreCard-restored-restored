@model Card

@{
    ViewBag.Title = Model.Year + " Score Card";
}

<div class="page-header">
    <h2>ICO @Model.Year Global Value Tracking</h2>
</div>

<div class="row">
    <div class="col-md-12">
        @using (Html.Bootstrap().Begin(new Table().Id("scoreCard").Condensed().Hover()))
        {
            <tr class="scoreheader">
            <th colspan="3">Area</th>
            <th>Measure</th>
            <th>Owner</th>
            <th>FY<br/>Target</th>
            <th>FY<br/>Total</th>
            <th>JAS</th>
            <th>OND</th>
            <th>JFM</th>
            <th>AMJ</th>
            <th>Comment</th>
            </tr>
            @Html.DisplayFor(m=>m.Lines)
        } 
    </div>
</div>

@section scripts {
<script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>
<script type="text/javascript">
    function cuetarget(e, t, s) {
        var cue = "-primary";
        if (t > s) cue = "-danger";
        if (t < s) cue = "-success";
        e.removeClass("text-danger text-success text-primary").addClass("text-"+cue);
        e.removeClass("bg-danger bg-success bg-primary").addClass("bg-" + cue);
    }
    function fixpoint(e) {
        var points = e.attr('mask');
        var val = e.val();
        if (points > 0) {
            var point = val.indexOf('.');
            if (point == 0)
                val = val + ".00".substr(0, points + 1);
            else
                val = val + "00".substr(0, val.length - point - 1);

            e.val(val);
        }
        return points;
    }
    function recalc(e, path) {
        var sum = 0;
        var rw = e.closest('tr');
        var q = 0;
        $('.quarval', rw).each(function () {
            var item = Number($(this).val());
            sum += item;
            var p = $(this).attr('id').split('_');
            var qrt = p[p.length-1][1];
            if (item == 0 && qrt > q)
                q = qrt;
        });
        $('.yearval', rw).val(sum);     // total on row
        cuetarget($('.yearval', rw), Number($('.targval', rw).val() * q), Number(4 * sum));

        if (path[3] == 'scores') {
            var target = '#' + path.slice(0, 3).join('_') + '_sub' + path.slice(5).join('_');
            var prefix = path.slice(0, 4).join('_');
            var suffix = path.slice(5).join('_');
            sum = 0;
            var scope = '[data-lineid=' + rw.data('lineid') + ']';
            var search = '[id^=' + prefix + '][id$=' + suffix + ']';
            $(search, scope).each(function () {
                sum += Number($(this).val());
            });
            $(target).val(sum);         // total on column
            fixpoint($(target));

            scope = $(target).closest('tr');
            target = '#' + path.slice(0, 3).join('_') + '_sub_Total'
            search = '[id^=' + path.slice(0, 3).join('_') + '_sub_Q]';
            sum = 0;
            $(search, scope).each(function () {
                sum += Number($(this).val());
            });
            $(target).val(sum);
            fixpoint($(target));
        }
    }
    $(function () {
        $('.subscore').hide();
        var card = $.connection.scoreHub;
        card.client.reflectLine = function (lineid, scoreid, q1, q2, q3, q4, comment) {

        };
        card.client.reflectCell = function (scoreid, quarterid, value) {
            var target = $('[id$=Q' + quarterid + ']', '.subscore[data-scoreid=' + scoreid + ']');
            var points = target.attr('mask');
            target.val(value / (+"100".substr(0, points + 1)));
            var path = target.attr('id').split('_');
            recalc(target, path);
        };
        card.client.reflectComment = function (scoreid, comment) {
            var target = $('[id$=Comment]', '.subscore[data-scoreid=' + scoreid + ']');
            target.val(comment);
        };
        $('tr.details').on('click', function () {
            var caret = $('i.fa', $(this));
            var scope = '.subscore[data-lineid=' + $(this).data('lineid') + ']';
            if (caret.attr('class').indexOf('right') > 0) {
                caret.removeClass("fa-caret-right").addClass("fa-caret-down");
                $(scope).toggle();
            } 
            else {
                caret.removeClass("fa-caret-down").addClass("fa-caret-right");
                $(scope).toggle();
            }
        });
        $.connection.hub.start().done(function () {
            $('.quarval').on('change', function () {
                var path = $(this).attr('id').split('_');
                var row = $(this).closest('tr');
                var sid = Number(row.data('scoreid'));
                if (sid == 0)
                    sid = -Number(row.data('lineid'));
                var qid = Number(path[path.length - 1][1]);
                var points = fixpoint($(this));
                card.server.updateCell(sid, qid, Number($(this).val())* (+"100".substr(0, points + 1)));
                recalc($(this), path);
            });
            $('.scoreComment').on('change', function () {
                var row = $(this).closest('tr');
                var sid = Number(row.data('scoreid'));
                if (sid == 0)
                    sid = -Number(row.data('lineid'));
                var val = $(this).val();
                card.server.updateComment(sid, val);
            });
        });

    });
</script>
}